import{r as t,K as ae,T as be,j as e}from"./index-CpoNZy_K.js";import{A as fe}from"./AdaptableCard-BrRUUEaN.js";import"./Views-Dk2fMzxD.js";import{B as C,F as ve,D as X,S as Y}from"./DataTable-Dd0ah6Zu.js";import"./SvgIcon-CF7LUJah.js";import"./index-DnNRFRxm.js";import{B as i}from"./Button-5FPMlk4P.js";import{D as Z,a as ye,t as c,N as d}from"./Upload-BWEhbG-n.js";import{I as w}from"./hoist-non-react-statics.cjs-CSsTDRi9.js";import{p as Ne,q as Se,l as Ce,m as we,r as ke,s as Ae,o as Pe}from"./index-U2oPHaYB.js";import{u as Ee}from"./useThemeClass-BqZMVik2.js";import{u as ee}from"./useQuery-CdU9hP8Y.js";import{u as se}from"./useMutation-CVmbNRHT.js";import{d as Oe}from"./debounce-DPZCkTRe.js";import{a as Re,b as De,c as Fe,d as Me}from"./ProductService-X_fYFXrO.js";import{a as Ie}from"./EmployeeService.ts-DIGrsvEt.js";import"./Alert-DmmJ-CO8.js";import"./index-DcKY4__E.js";import"./Drawer-YiESGu5W.js";import"./index-2_f4dh3X.js";import"./index-UDOHiYwi.js";import"./ScrollBar-Bxslmpi8.js";import{M as _e}from"./index-B_aK2khu.js";import"./cloneDeep-DgnTTuDI.js";import"./index-1G6_mNEt.js";import"./CloseButton-CrGnf40L.js";import"./toString-BjSMy3v_.js";import"./_getPrototype-DwJTGY_5.js";const qe={assigned:"bg-blue-500",returned:"bg-emerald-500",lost:"bg-red-500",damaged:"bg-amber-500"},Le={excellent:"bg-green-500",good:"bg-blue-500",fair:"bg-yellow-500",poor:"bg-red-500"},Te=()=>{var $,G,U,V,J,W;const x=t.useRef(null),y=ae(),k=be(),{textTheme:te}=Ee(),[A,ne]=t.useState(""),[g,N]=t.useState({page:1,limit:10}),[ie,P]=t.useState(!1),[le,E]=t.useState(!1),[r,O]=t.useState(null),[l,R]=t.useState(null),[m,D]=t.useState(null),[h,S]=t.useState(1),[p,F]=t.useState(null),[M,I]=t.useState(""),[u,_]=t.useState("good"),[q,L]=t.useState([]),[j,T]=t.useState(null),[oe,z]=t.useState(!1),{data:o,isLoading:re,error:H,refetch:ce}=ee({queryKey:["products",g,A],queryFn:()=>Me({page:g.page,limit:g.limit,search:A})}),{data:b}=ee({queryKey:["employees-for-assignment"],queryFn:()=>Ie({page:1,limit:100})}),Q=se({mutationFn:De,onSuccess:()=>{c.push(e.jsx(d,{title:"Success",type:"success",children:"Product assigned successfully"})),k.invalidateQueries(["products"]),f()},onError:s=>{var a,n;c.push(e.jsx(d,{title:"Error",type:"danger",children:((n=(a=s.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to assign product"}))}}),K=se({mutationFn:s=>Fe(s.assignmentId,{condition:s.condition,notes:s.notes}),onSuccess:()=>{c.push(e.jsx(d,{title:"Success",type:"success",children:"Product returned successfully"})),k.invalidateQueries(["products"]),v(),L(s=>s.map(a=>a._id===(l==null?void 0:l.id)?{...a,status:"returned",condition:u}:a))},onError:s=>{var a,n;c.push(e.jsx(d,{title:"Error",type:"danger",children:((n=(a=s.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to return product"}))}}),de=async s=>{try{z(!0);const a=await Re(s);console.log("Assignments response:",a.data.data),L(a.data.data||[]),T(s)}catch(a){c.push(e.jsx(d,{title:"Error",type:"danger",children:"Failed to load assignments"})),console.error("Error loading assignments:",a)}finally{z(!1)}},me=t.useMemo(()=>Oe(s=>{ne(s),N(a=>({...a,page:1}))},500),[]),f=()=>{O(null),D(null),S(1),F(null),I(""),P(!1)},v=()=>{R(null),_("good"),E(!1)},ue=s=>{O({id:s._id,name:s.name,availableStock:s.availableStock}),S(1),P(!0)},ge=s=>{var a;if(console.log("Assignment data:",s),!s._id&&!s.id){console.error("No ID found in assignment:",s),c.push(e.jsx(d,{title:"Error",type:"danger",children:"Invalid assignment data"}));return}R({id:s._id||s.id,productName:((a=s.product)==null?void 0:a.name)||"Unknown Product"}),E(!0)},xe=async()=>{!r||!m||await Q.mutateAsync({productId:r.id,employeeId:m,quantity:h,expectedReturnAt:p==null?void 0:p.toISOString(),notes:M})},he=async()=>{if(console.log("Attempting to return:",l),!(l!=null&&l.id)){c.push(e.jsx(d,{title:"Error",type:"danger",children:"No valid assignment selected"}));return}try{await K.mutateAsync({assignmentId:l.id,condition:u,notes:`Returned in ${u} condition`})}catch(s){console.error("Return error:",s)}},B=t.useMemo(()=>{var s,a;return((a=(s=b==null?void 0:b.data)==null?void 0:s.data)==null?void 0:a.map(n=>({value:n._id,label:`${n.name} (${n.empId})`})))||[]},[b]),pe=t.useMemo(()=>[{header:"Product",accessorKey:"name",cell:s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-semibold",children:s.row.original.name}),j===s.row.original._id&&e.jsx(i,{size:"xs",variant:"plain",className:"ml-2",icon:e.jsx(Ne,{}),onClick:()=>T(null)})]})},{header:"Model",accessorKey:"model",cell:s=>e.jsx("span",{children:s.row.original.model})},{header:"Serial",accessorKey:"serialNumber",cell:s=>e.jsx("span",{className:"font-mono",children:s.row.original.serialNumber||"-"})},{header:"Stock",cell:s=>{const a=s.row.original;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(C,{className:a.availableStock>0?"bg-emerald-500":"bg-red-500",children:[a.availableStock,"/",a.totalStock]}),a.availableStock<a.totalStock&&e.jsx(i,{size:"xs",variant:"plain",icon:e.jsx(ve,{}),onClick:()=>de(a._id),children:"View Assignments"})]})}},{header:"Actions",id:"action",cell:s=>e.jsxs("div",{className:"flex justify-end text-lg gap-2",children:[e.jsx(i,{size:"xs",icon:e.jsx(Se,{}),disabled:s.row.original.availableStock<=0,onClick:()=>ue(s.row.original),children:"Assign"}),e.jsx(i,{size:"xs",icon:e.jsx(Ce,{}),onClick:()=>y(`/products/view/${s.row.original._id}`)}),e.jsx(i,{size:"xs",icon:e.jsx(we,{}),onClick:()=>y(`/products/edit/${s.row.original._id}`)})]})}],[y,j,te]),je=t.useMemo(()=>[{header:"Employee",cell:s=>{var a,n;return e.jsxs("span",{children:[((a=s.row.original.employee)==null?void 0:a.name)||"Unknown","(",((n=s.row.original.employee)==null?void 0:n.empId)||"N/A",")"]})}},{header:"Assigned On",cell:s=>e.jsx("span",{children:s.row.original.assignedAt?new Date(s.row.original.assignedAt).toLocaleDateString():"N/A"})},{header:"Quantity",cell:s=>e.jsx("span",{children:s.row.original.quantity})},{header:"Status",cell:s=>e.jsx(C,{className:qe[s.row.original.status]||"bg-gray-500",children:s.row.original.status})},{header:"Condition",cell:s=>s.row.original.condition?e.jsx(C,{className:Le[s.row.original.condition]||"bg-gray-500",children:s.row.original.condition}):e.jsx("span",{children:"-"})},{header:"Actions",cell:s=>s.row.original.status==="assigned"?e.jsx(i,{size:"xs",icon:e.jsx(_e,{}),onClick:()=>{var a;return ge({_id:s.row.original._id,id:s.row.original.id,product:{name:(a=s.row.original.product)==null?void 0:a.name},...s.row.original})},children:"Return"}):e.jsx("span",{className:"text-gray-400",children:"Completed"})}],[]);return H?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("span",{className:"text-red-500",children:["Error: ",H.message]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx(w,{placeholder:"Search products...",onChange:s=>me(s.target.value),className:"max-w-md"}),e.jsx(i,{icon:e.jsx(ke,{}),onClick:()=>ce(),children:"Refresh"})]}),j?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"mb-4",children:[e.jsxs("h4",{className:"mb-2",children:["Assignments for Product: ",(U=(G=($=o==null?void 0:o.data)==null?void 0:$.data)==null?void 0:G.find(s=>s._id===j))==null?void 0:U.name]}),oe?e.jsx("div",{className:"text-center py-4",children:"Loading assignments..."}):q.length>0?e.jsx(X,{ref:x,columns:je,data:q}):e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{children:"No assignments found for this product"})})]})}):e.jsx(X,{ref:x,columns:pe,data:((V=o==null?void 0:o.data)==null?void 0:V.data)||[],loading:re,pagingData:{total:((J=o==null?void 0:o.data)==null?void 0:J.total)||0,pageIndex:g.page,pageSize:g.limit},onPaginationChange:s=>N(a=>({...a,page:s})),onSelectChange:s=>N({page:1,limit:s})}),e.jsxs(Z,{isOpen:ie,onClose:f,onRequestClose:f,width:500,children:[e.jsx("h4",{className:"mb-4",children:"Assign Product"}),r&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:r.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Available: ",r.availableStock]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Employee"}),e.jsx(Y,{placeholder:"Select Employee",options:B,value:m?{value:m,label:(W=B.find(s=>s.value===m))==null?void 0:W.label}:null,onChange:s=>D(s==null?void 0:s.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Quantity"}),e.jsx(w,{type:"number",min:1,max:r.availableStock,value:h,onChange:s=>{const a=parseInt(s.target.value);S(isNaN(a)?1:Math.max(1,Math.min(a,r.availableStock)))}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Expected Return Date (Optional)"}),e.jsx(ye,{placeholder:"Select date",value:p,onChange:s=>F(s)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notes (Optional)"}),e.jsx(w,{type:"text",value:M,onChange:s=>I(s.target.value),placeholder:"Additional notes"})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(i,{variant:"plain",onClick:f,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:xe,loading:Q.isLoading,disabled:!m||h<1||h>r.availableStock,children:"Confirm Assignment"})]})]})]}),e.jsxs(Z,{isOpen:le,onClose:v,onRequestClose:v,width:400,children:[e.jsx("h4",{className:"mb-4",children:"Return Product"}),l&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Product"}),e.jsx("p",{className:"font-semibold",children:l.productName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Condition"}),e.jsx(Y,{value:{value:u,label:u.charAt(0).toUpperCase()+u.slice(1)},options:[{value:"excellent",label:"Excellent"},{value:"good",label:"Good"},{value:"fair",label:"Fair"},{value:"poor",label:"Poor"}],onChange:s=>_(s.value)})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(i,{variant:"plain",onClick:v,children:"Cancel"}),e.jsx(i,{variant:"solid",onClick:he,loading:K.isLoading,icon:e.jsx(Ae,{}),children:"Confirm Return"})]})]})]})]})},ze=()=>{const x=ae();return e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:e.jsx(i,{variant:"solid",size:"sm",icon:e.jsx(Pe,{}),onClick:()=>x("/products/create"),children:"Add Product"})})},hs=()=>e.jsxs(fe,{className:"h-full",bodyClass:"h-full",children:[e.jsxs("div",{className:"lg:flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"mb-4 lg:mb-0",children:"Products"}),e.jsx(ze,{})]}),e.jsx(Te,{})]});export{hs as default};
